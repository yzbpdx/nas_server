<!DOCTYPE html>
<html>
<head>
    <title>Server Folder</title>
	<style>
		.folder-icon {
			margin-right: 5px;
		}
	
		.list-group {
			display: flex;
			flex-wrap: wrap;
		}
	
		.list-group-item {
			width: 100%; /* 每行显示4个文件夹，根据需求调整宽度 */
			padding: 0.5rem;
			border: none;
		}
	</style>	
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
			var currentPath
            function getRootFolder() {
                $.ajax({
                    url: '/root',
                    method: 'GET',
                    success: function(response) {
                        showFolders(response.folders);
                        showFiles(response.files);
						var pageTitle = $('h1');
                        var pathSpan = $('<span>').text(' ' + response.currentPath);
                        pageTitle.append(pathSpan);
						currentPath = response.currentPath
                    }
                });
            }

			function getFolderFile(folderName) {
				var data = {
					folderName: folderName
				};
				$.ajax({
                    url: '/folder',
                    method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(data),
                    success: function(response) {
                        showFolders(response.folders);
                        showFiles(response.files);
						var pageTitle = $('h1');
						pageTitle.empty();
                        var pathSpan = $('<span>').text('Current File Path: ' + response.currentPath);
                        pageTitle.append(pathSpan);
						currentPath = response.currentPath
                    }
                });
			}

            function showFolders(folders) {
                var foldersList = $('#foldersList');
                foldersList.empty();
                folders.forEach(function(folder) {
					var link = $('<a>').attr('href', '#').text(folder);
                    var listItem = $('<li>').append(link);
                    foldersList.append(listItem);
                });
            }

            function showFiles(files) {
                var filesList = $('#filesList');
                filesList.empty();
                files.forEach(function(file) {
                    var link = $('<a>').attr('href', '#').text(file);
                    var listItem = $('<li>').append(link)
                    filesList.append(listItem);
                });
            }

            function downloadFile(currentPath, fileName) {
                var data = {
                    filePath: currentPath,
					fileName: fileName
				};
				$.ajax({
                    url: '/download',
                    method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(data),
                    responseType: 'blob',
                    success: function(response) {
                        const fileData = response;
                        const fileUrl = URL.createObjectURL(new Blob([fileData], {type: 'application/txt'}));
                        // window.open(fileUrl, '_blank');
                        const link = document.createElement('a');
                        link.href = fileUrl;
                        link.download = fileName;
                        link.click();

                        URL.revokeObjectURL(fileUrl);
                    }
                });
            }

			$('#foldersList').on('click', 'li', function() {
                var clickFolder = $(this).text();
                getFolderFile(currentPath + clickFolder);
            });

            $('#filesList').on('click', 'li', function() {
                var clickFile = $(this).text();
                downloadFile(currentPath, clickFile);
            });

            getRootFolder();
        });
    </script>
</head>
<body>
	<h1>Current File Path:</h1>
    <h2>Folders:</h2>
    <ul id="foldersList"></ul>
    <h2>Files:</h2>
    <ul id="filesList"></ul>
</body>
</html>
